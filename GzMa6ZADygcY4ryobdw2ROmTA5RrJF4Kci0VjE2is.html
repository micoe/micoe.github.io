import datetime,json,time,pytz,re

def allow():
    al = requests.get(folder.replace('lanzous','lanzoui'), headers={'User-Agent': 'yaohuoid34976'}).text
    sw=re.search(r'<title>.+</title>', al).group()
    if sw[7:8] == '2':
        print('云函数接单开关已关闭')
        return
    else:return sw[8:-8]

def login(token):
    global tb
    s.headers={'Cookie':'token='+token}
    try:
        tb=s.get(url + 'user/user_info').json()['result']['aliwangwang']
        print(tb, '登陆成功开始接单...')
        return 1
    except:
        print(phone,'登陆失败,请重命名蓝奏云更新ck或关闭云函数接单开关')
        requests.post('http://www.pushplus.plus/send', data=json.dumps({"token": Token, "title": '(港仔猫)ck已过期请及时更新',"content": {'ck获取网站': '<a href="http://a.jq9i.cn">http://a.jq9i.cn</a>','接单账号': phone,'注意':'您的港仔猫账号ck已过期，请及时更新或者关闭云函数接单开关，ck版云函数使用教程见<a href="https://scflover.cf/tg">tg群</a>'}, "template": "json"}),headers={'Content-Type': 'application/json'})
        return

def check():
    o = s.get(url + 'order/get_order_list?start_date=' + datetime.datetime.now(pytz.timezone('PRC')).strftime('%Y-%m-%d') + '&end_date=' + datetime.datetime.now(pytz.timezone('PRC')).strftime('%Y-%m-%d') + '&page_size=100&page_num=1').json()
    for i in o['result']['data']:
        if i['status'] == 40:
            print('今日已接过任务，请明日再来接单')
            return
        if i['status'] == 10 or i['status'] == 20:
            print('您有待完成的任务')
            task_id = s.get(url + 'order/order_info?order_id=' + i['id']).json()['result']['task_id']
            inf(task_id, i['id'])
            return
    return 1

def inf(task_id,order_id):
    key = s.get(url + 'task/keyword', params=(('task_id', task_id), ('order_id', order_id))).json()
    k = key['result']
    img = k['product_images']
    u = k['product_url']
    word = k['keywords']
    end = k['end_time']
    p = k['capital']
    print(p, u, word, end)
    notice=requests.post('http://www.pushplus.plus/send', data=json.dumps({"token": Token, "title": '(港仔猫)金额 ' + p +' 旺旺号:'+tb,"content": {'<a href="http://qr61.cn/ogpvAF/qtDE2Ly" style="color:black">'+Co+'</a>':'All rights reserved','商品主图': '<img src="' + img + '" alt="商品主图" width="100%"/>','商品链接': u, '关键词': word,'结束时间': end,'做单网站':'<a href="http://a.jq9i.cn">http://a.jq9i.cn</a>','接单账号':phone},"template": "json"}),headers={'Content-Type': 'application/json'})
    if notice.json()['code'] == 200:print('接单成功已推送')
    else:print('接单成功推送失败')
    return

def main():
    global s,Co
    Co = 'Copyright © 2021 初音ミク'
    print('微信revolfcs为您提供最高效的港仔猫云函数服务\n'+Co+'\n当前代码版本：v2.1')
    wait_until = datetime.datetime.now() + datetime.timedelta(hours=0.24)
    s = requests.session()
    n=allow()
    if n:
        if login(n):
            if check():
                while True:
                    try:
                        r = s.get(url + 'task/receive_task_list?page_size=30&page_num=1').json()
                        if r['code']==202:
                            requests.post('http://www.pushplus.plus/send', data=json.dumps({"token": Token, "title": '(港仔猫)请先完成任务消息再来接单!', "content": {'做单网站': '<a href="http://a.jq9i.cn">http://a.jq9i.cn</a>','接单账号': phone}, "template": "json"}), headers={'Content-Type': 'application/json'})
                            print(r['error_msg'])
                            return
                        if r['result']:
                            for i in r['result']['data']:
                                rec = s.post(url + 'task/user_receive_task', data={'task_id': i['id']}).json()
                                print(rec['error_msg'])
                                if rec['result']:
                                    inf(i['id'], rec['result']['order_id'])
                                    return
                    except:
                        pass
                    time.sleep(15)
                    if wait_until < datetime.datetime.now():
                        print('接单即将超时，任务将在下次触发继续执行')
                        return

url = "http://d.jsy188.cn/api/"
main()