import multiprocessing,datetime,json,time,pytz,re

def allow():
    al = requests.get(folder.replace('lanzous','lanzoui'), headers={'User-Agent': 'yaohuoid34976'}).text
    if re.search(r'<title>\d+</title>', al).group()[7:8] == '2':
        print('云函数接单开关已关闭')
        return False
    else:return 1

def login():
    global tb
    s.post(url + 'user/login', data={"phone": phone, "password": password, "type": "password"})
    tb=s.get(url + 'user/user_info').json()['result']['aliwangwang']
    print(tb, '登陆成功开始接单...')

def check():
    o = s.get(url + 'order/get_order_list?start_date=' + datetime.datetime.now(pytz.timezone('PRC')).strftime('%Y-%m-%d') + '&end_date=' + datetime.datetime.now(pytz.timezone('PRC')).strftime('%Y-%m-%d') + '&page_size=100&page_num=1').json()
    for i in o['result']['data']:
        if i['status'] == 40:
            print('近两日已接过任务，请在上次完成任务后隔一天再来接单')
            return
        if i['status'] == 10 or i['status'] == 20:
            print('您有待完成的任务')
            task_id = s.get(url + 'order/order_info?order_id=' + i['id']).json()['result']['task_id']
            inf(task_id, i['id'])
            return
    return 1

def inf(task_id,order_id):
    key = s.get(url + 'task/keyword', params=(('task_id', task_id), ('order_id', order_id))).json()
    k = key['result']
    img = k['product_images']
    u = k['product_url']
    word = k['keywords']
    end = k['end_time']
    title = k['mode_title']
    p = k['capital']
    print(p, u, word, end,title)
    notice=requests.post('http://www.pushplus.plus/send', data=json.dumps({"token": Token, "title": '(牛易)金额 ' + p +' 旺旺号:'+tb,"content": {'<a href="http://qr61.cn/ogpvAF/qtDE2Ly" style="color:black">'+Co+'</a>':'All rights reserved','商品主图': '<img src="' + img + '" alt="商品主图" width="100%"/>','商品链接': u, '关键词': word,'标题': title,'做单网站':'<a href="http://a.jsy188.cn">http://a.jsy188.cn</a>','接单账号':phone},"template": "json"}),headers={'Content-Type': 'application/json'})
    if notice.json()['code'] == 200:print('接单成功已推送')
    else:print('接单成功推送失败')
    return

def main():
    global Co
    Co = 'Copyright © 2021 初音ミク'
    print('微信revolfcs为您提供最高效的牛易云函数服务\n'+Co+'\n当前代码版本：v1.1')
    wait_until = datetime.datetime.now() + datetime.timedelta(hours=0.24)
    l=[]
    for i in account:
        p = multiprocessing.Process(target=go, args=(i['folder'],i['Token'],i['phone'],i['password'],wait_until,Co))
        l.append(p)
        p.start()
    for i in l:
        i.join()

def go(a,b,c,d,wait_until,f):
    global s,phone,password,folder,Token,Co
    folder=a
    Token=b
    phone= c
    password=d
    Co = f
    s = requests.session()
    n=allow()
    if n:
        login()
        if check():
            while True:
                try:
                    r = s.get(url + 'task/receive_task_list?page_size=30&page_num=1').json()
                    if r['code']==202:
                        requests.post('http://www.pushplus.plus/send', data=json.dumps({"token": Token, "title": '(牛易)请先完成任务消息再来接单!', "content": {'做单网站': '<a href="http://a.jsy188.cn">http://a.jsy188.cn</a>','接单账号': phone}, "template": "json"}), headers={'Content-Type': 'application/json'})
                        print(r['error_msg'])
                        return
                    if r['result']:
                        for i in r['result']['data']:
                            rec = s.post(url + 'task/user_receive_task', data={'task_id': i['id']}).json()
                            print(rec['error_msg'])
                            if rec['result']:
                                inf(i['id'], rec['result']['order_id'])
                                return
                except:
                    pass
                time.sleep(15)
                if wait_until < datetime.datetime.now():
                    print('接单即将超时，任务将在下次触发继续执行')
                    return

url = "http://a.jsy188.cn/api/"
main()