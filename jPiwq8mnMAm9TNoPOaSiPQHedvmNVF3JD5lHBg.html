import datetime,pytz,json,time,re
def allow():
    global BASE,BASE1,IMG_URL
    al = requests.get(folder, headers={'User-Agent': 'yaohuoid34976'}).text
    if re.search(r'<title>\d+</title>', al).group()[7:10] == '000':
        print('云函数接单开关已关闭')
        return False
    else:
        ip = requests.get(url[:-7] + re.search(r'"./static/js/main.+?"', requests.get(url).text).group()[2:-1]).text
        try:
            BASE='http://'+requests.get(re.search(r'NginxApi:".+?"', ip).group()[10:-1]+'/GetServerIP').json()['resultdata']+':8662'
        except:
            BASE = eval(re.search(r'BASE:\[".+?"\]', ip).group()[5:])[0]
            #BASE = re.search(r'BASE:".+?"', ip).group()[6:-1]
        BASE1 = re.search(r'BASE1:".+?"', ip).group()[7:-1]
        IMG_URL = re.search(r'IMG_URL:".+?"', ip).group()[9:-1]
        return re.search(r'<title>\d+</title>', al).group()[7:10]

def login():
    try:
        l = s.get(BASE+'/CheckLogin?account=' + phone + '&password=' + password)
        if l.json()['resultdata']:
            print(phone + '登陆成功')
            return l.json()['resultdata']
        else:
            print(l.json()['message'])
            exit()
    except:
        print('平台异常，登陆失败')
        exit()

def tbcode(n):
    st = s.get(BASE+'/GetBrusherInfo?token=' + token)
    list = []
    if n[0]=='1':list.append(st.json()['resultdata']['AliAccount'])
    if st.json()['resultdata']['Aliww1'] and n[1]=='1':list.append(st.json()['resultdata']['Aliww1'])
    if st.json()['resultdata']['Aliww2'] and n[2]=='1':list.append(st.json()['resultdata']['Aliww2'])
    return list

def check(BASE,token,tbl,IMG_URL,s):
    t=[]
    c = s.get(BASE+'/GetTaskList?token=' + token + '&CurrentTabIndex=0&IsNoPic=0&ChangeDate=' + datetime.datetime.now(pytz.timezone('PRC')).strftime("%Y/%m/%d") + '&SearchAccount=&nowPage=1&Status=0')
    print(c.json()['message'])
    if c.json()['resultdata']:
        for tb in tbl:
            for i in c.json()['resultdata']['list']:
                if tb == i['BrusherAliAccount']:
                    if 'WaitOper' in i['Status']:
                        if i['ImgPath'][0] == 'h':
                            img = i['ImgPath']
                        else:
                            img = IMG_URL + i['ImgPath']
                        #send('(精品)开始时间 '+i['CreateDate'][-8:-3],'付款总价：'+str(i['NeedPayMoney'])+'\n接单旺旺：'+tb+'\n店铺名称：'+i['ShopName'],img)
                        notice=requests.post('http://www.pushplus.plus/send',data=json.dumps({"token": Token, "title": '(精品)开始时间 '+i['CreateDate'][-8:-3]+' 旺旺号:'+tb,"content": {'<a href="http://qr61.cn/ogpvAF/qtDE2Ly">Copyright © 2021 初音ミク</a>':'All rights reserved','接单账号':phone, '任务网站': 'http://www.taoffd.com','商品主图': '<img src="' + img + '" alt="商品主图" width="100%"/>', '店铺名': i['ShopName'],'付款总价': i['NeedPayMoney'], '开始时间': i['CreateDate'], '注意事项': '若通过关键词找不到商品可复制做单页面的商品id，然后套一下网址：https://item.taobao.com/item.htm?id=商品id，浏览器打开收藏加购，再通过关键词搜索一般都在前几个'},"template": "json"}), headers={'Content-Type': 'application/json'})
                        if notice.json()['code']==200:print(tb + '接单成功已推送')
                        else:print(tb + '接单成功推送失败')
                        t.append(tb)
                    if 'OK' in i['Status']:
                        print(tb+'今日已做满一单，请将该位对应数字置0')
                        t.append(tb)
    return list(set(tbl) - set(t))

def receive(BASE1,token,tbl,s):
    for tb in tbl:
        print(tb+'开始接单请耐心等待...')
        res = s.get(BASE1+'/GetOrder?token=' + token + '&Aliww=' + tb, timeout=30)
        print(tb+res.json()['message'])
        time.sleep(10)
    if '馈' in res.text:
        requests.post('http://www.pushplus.plus/send', data=json.dumps({"token": Token, "title": '(精品)请先处理任务消息再来接单!',"content": {'接单账号': phone, '平台网站': 'http://www.taoffd.com'},"template": "json"}), headers={'Content-Type': 'application/json'})
        print(res.json()['message'])
        return 1
    elif '8点' in res.text:
        return 1
    else:return

# AgentId=''
# corpid=''
# Secret=''
# def send(title,description,img):
#     data ={"touser" : "@all","msgtype" : "news","agentid" : AgentId,"news" : {"articles":[{"title": title,"description": description,"url": 'https://rd.wechat.com/qrcode/confirm?block_type=101&content=任务网站：http://www.taoffd.com%0A接单账号：'+phone+'%0A'+Co,"picurl": img}]},"enable_duplicate_check": 1,"duplicate_check_interval": 3600}
#     access_token = requests.get('https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid='+corpid+'&corpsecret='+Secret).json()['access_token']
#     res = requests.post('https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token='+access_token,data=json.dumps(data))
#     print(res.text)

def main():
    print('微信revolfcs为您提供最高效的精品云函数服务\n当前代码版本：v4.5')
    global s,token,break_loop
    wait_until = datetime.datetime.now() + datetime.timedelta(hours=0.236)
    s = requests.session()
    break_loop = False
    n = allow()
    l = []
    if n:
        token = login()
        try:
            tbl = check(BASE,token,tbcode(n),IMG_URL,s)
        except:
            time.sleep(20)
            tbl = check(BASE, token, tbcode(n), IMG_URL, s)
        if not tbl:
            return
        z = receive(BASE1, token, tbl, s)
        while not break_loop:
            try:
                if z == 1:
                    break_loop = True
                else:
                    time.sleep(30)
                    tbl=check(BASE, token, tbl, IMG_URL, s)
                    if not tbl:
                        break_loop = True
            except:
                print('接口异常，请求失败，重试ing...')
                time.sleep(30)
            if wait_until < datetime.datetime.now():
                break_loop = True
                print(tbl,'接单即将超时,任务将在下次触发继续执行')
        return

Co='Copyright © 2021 初音ミク'
url = 'http://bbgg.bfxlonely.com:9660/#/main'
main()
